name: Auto Issue Resolver

on:
  schedule:
    # 20åˆ†ã”ã¨ã«å®Ÿè¡Œï¼ˆ24æ™‚é–“365æ—¥ï¼‰
    - cron: '*/20 * * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  issue_comment:
    types: [created]
  push:
    branches:
      - 'claude/issue-*'
  issues:
    types: [closed]

# ã‚¹ãƒ†ãƒ¼ãƒˆãƒ©ãƒ™ãƒ«ã®å®šç¾©
env:
  STATE_LABELS: |
    claude:queued
    claude:working
    claude:needs-review
    claude:done
    claude:failed

# ä¸¦è¡Œå®Ÿè¡Œåˆ¶å¾¡: cronã‚¸ãƒ§ãƒ–ã¯ç‹¬ç«‹ã—ãŸã‚°ãƒ«ãƒ¼ãƒ—ã§ç®¡ç†
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'schedule' && 'cron' || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'schedule' }}

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¨©é™ã¯æœ€å°é™ã«
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # Job 1: å®šæœŸå®Ÿè¡Œã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œã§æ–°ã—ã„issueã‚’å‡¦ç†
  process-issue:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.find-issue.outputs.issue_number }}
      process_status: ${{ steps.find-issue.outputs.process_status }}
    
    steps:
      - name: Find and process highest priority issue
        id: find-issue
        uses: actions/github-script@v7
        with:
          # Personal Access Tokenã‚’ä½¿ç”¨ï¼ˆè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯GITHUB_TOKENã‚’ä½¿ç”¨ï¼‰
          github-token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          script: |
            // ã‚¹ãƒ†ãƒ¼ãƒˆãƒ©ãƒ™ãƒ«ã‚’envã‹ã‚‰å–å¾—
            const stateLabelsArray = process.env.STATE_LABELS.trim().split('\n');
            const stateLabels = {
              queued: stateLabelsArray[0],
              working: stateLabelsArray[1],
              needsReview: stateLabelsArray[2],
              done: stateLabelsArray[3],
              failed: stateLabelsArray[4]
            };
            
            // å„ªå…ˆåº¦é †ã«issueã‚’æ¢ã™
            const priorities = ['high', 'middle', 'low'];
            
            try {
              for (const priority of priorities) {
                // å„ªå…ˆåº¦ãƒ©ãƒ™ãƒ«ãŒã¤ã„ãŸissueã‚’å–å¾—ï¼ˆä½œæˆæ—¥æ™‚ã®é™é †ï¼‰
                const issues = await github.rest.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  labels: priority,
                  state: 'open',
                  sort: 'created',
                  direction: 'desc',
                  per_page: 100
                });
                
                // æœªå‡¦ç†ã®issueã‚’æ¢ã™ï¼ˆclaude:*ãƒ©ãƒ™ãƒ«ãŒã¤ã„ã¦ã„ãªã„ã‚‚ã®ï¼‰
                const unprocessedIssue = issues.data.find(issue => 
                  !issue.labels.some(label => label.name.startsWith('claude:'))
                );
                
                if (unprocessedIssue) {
                  console.log(`Found unprocessed issue #${unprocessedIssue.number} with priority: ${priority}`);
                  
                  // queuedãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: unprocessedIssue.number,
                    labels: [stateLabels.queued]
                  });
                  
                  // @claudeãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
                  const comment = await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: unprocessedIssue.number,
                    body: [
                      `@claude ã“ã®Issue #${unprocessedIssue.number} ã‚’è§£æ±ºã—ã¦ãã ã•ã„ã€‚`,
                      '',
                      'ä»¥ä¸‹ã®å†…å®¹ã«åŸºã¥ã„ã¦ã€å…·ä½“çš„ãªå®Ÿè£…æ–¹é‡ã¨å¿…è¦ãªã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ææ¡ˆã—ã¦ãã ã•ã„ï¼š',
                      '',
                      `**ã‚¿ã‚¤ãƒˆãƒ«**: ${unprocessedIssue.title}`,
                      '',
                      '**èª¬æ˜**:',
                      unprocessedIssue.body || 'èª¬æ˜ãªã—',
                      '',
                      `å„ªå…ˆåº¦: ${priority}`,
                      '',
                      '---',
                      '_ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ClaudeãŒå¿œç­”ã™ã‚‹ã¨ã€ä¿®æ­£æ¡ˆã®PRãŒä½œæˆã•ã‚Œã¾ã™ã€‚_'
                    ].join('\n')
                  });
                  
                  // queuedãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤ã—ã¦workingãƒ©ãƒ™ãƒ«ã«å¤‰æ›´
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: unprocessedIssue.number,
                    name: stateLabels.queued
                  }).catch(() => {});
                  
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: unprocessedIssue.number,
                    labels: [stateLabels.working]
                  });
                  
                  console.log(`Claude mention posted on issue #${unprocessedIssue.number}`);
                  core.setOutput('issue_number', unprocessedIssue.number.toString());
                  core.setOutput('process_status', 'success');
                  return; // 1ã¤ã®issueã®ã¿å‡¦ç†ã—ã¦çµ‚äº†
                }
              }
              
              console.log('No unprocessed issues found');
              core.setOutput('issue_number', '');
              core.setOutput('process_status', 'no_issues');
              
            } catch (error) {
              console.error('Error processing issues:', error);
              core.setOutput('process_status', 'error');
              core.setOutput('error_message', error.message);
              throw error; // fail-handlerã‚¸ãƒ§ãƒ–ã§å‡¦ç†
            }

  # Job 2: ClaudeãŒã‚³ãƒ¡ãƒ³ãƒˆã¾ãŸã¯ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸæ™‚ã«PRã‚’ä½œæˆ
  handle-claude-changes:
    # å³å¯†ãªæ¡ä»¶ãƒã‚§ãƒƒã‚¯
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/claude/issue-')) ||
      (github.event_name == 'issue_comment' && 
       github.event.action == 'created' &&
       github.event.comment.user.login == 'claude[bot]' &&
       contains(github.event.issue.labels.*.name, 'claude:working'))
    
    runs-on: ubuntu-latest
    # ã“ã®ã‚¸ãƒ§ãƒ–ã¯ contents: write ãŒå¿…è¦
    permissions:
      contents: write
      pull-requests: write
      issues: write
    outputs:
      issue_number: ${{ steps.extract-issue.outputs.issue_number }}
      pr_created: ${{ steps.create-pr.outputs.pr_exists == 'false' && steps.create-pr.outputs.pr_number != '' }}
    
    steps:
      - name: Extract issue number
        id: extract-issue
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰Issueç•ªå·ã‚’æŠ½å‡ºï¼ˆclaude/issue-123 -> 123ï¼‰
            ISSUE_NUM=$(echo "${{ github.ref_name }}" | sed 's/claude\/issue-//')
            echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
          else
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'push' && github.ref || 'main' }}
      
      - name: Check for changes
        id: check-changes
        run: |
          # ClaudeãŒãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸå ´åˆã€å¤‰æ›´ãŒã‚ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "branch_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            # ã‚³ãƒ¡ãƒ³ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã¯ã€ClaudeãŒãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ãŸã‹ãƒã‚§ãƒƒã‚¯
            BRANCH_NAME="claude/issue-${{ steps.extract-issue.outputs.issue_number }}"
            if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: Run tests on Claude's changes
        if: steps.check-changes.outputs.has_changes == 'true' && github.event_name == 'push'
        id: run-tests
        continue-on-error: true
        run: |
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿œã˜ãŸãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
          if [ -f "package.json" ]; then
            npm ci
            npm run build || echo "BUILD_FAILED=true" >> $GITHUB_ENV
            npm test || echo "TEST_FAILED=true" >> $GITHUB_ENV
          elif [ -f "Makefile" ]; then
            make test || echo "TEST_FAILED=true" >> $GITHUB_ENV
          else
            echo "No test runner found, skipping tests"
          fi
      
      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt('${{ steps.extract-issue.outputs.issue_number }}');
            const branchName = '${{ steps.check-changes.outputs.branch_name }}';
            
            // ã™ã§ã«PRãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const existingPRs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branchName}`,
              state: 'open'
            });
            
            if (existingPRs.data.length > 0) {
              console.log(`PR already exists: ${existingPRs.data[0].html_url}`);
              core.setOutput('pr_exists', 'true');
              core.setOutput('pr_url', existingPRs.data[0].html_url);
              return;
            }
            
            // Issueæƒ…å ±ã‚’å–å¾—
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const testStatus = process.env.TEST_FAILED ? 'âŒ Tests failed' : 
                            process.env.BUILD_FAILED ? 'âš ï¸ Build failed' : 
                            'âœ… Tests passed';
            
            // PRã‚’ä½œæˆ
            const prBody = [
              '## ğŸ¤– Automated fix by Claude',
              '',
              `Fixes #${issueNumber}`,
              '',
              '### Summary',
              `This PR contains automated fixes implemented by Claude Code for the issue "${issue.data.title}".`,
              '',
              '### Test Status',
              testStatus,
              '',
              '### Changes',
              'Please review the changes carefully before merging.',
              '',
              '---',
              `_This PR was automatically generated after Claude Code processed issue #${issueNumber}_`
            ].join('\n');
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ¤– Claude fix: ${issue.data.title}`,
              head: branchName,
              base: 'main',
              body: prBody,
              draft: true
            });
            
            core.setOutput('pr_number', pr.data.number);
            core.setOutput('pr_url', pr.data.html_url);
            core.setOutput('pr_exists', 'false');
            
            // å…ƒã®issueã«PRãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
            const commentBody = [
              `ğŸ‰ Claude has implemented a fix and created a draft PR: ${pr.data.html_url}`,
              '',
              'Please review the changes and merge if they look good.'
            ].join('\n');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: commentBody
            });
      
      - name: Update issue labels
        if: always() && steps.extract-issue.outputs.issue_number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt('${{ steps.extract-issue.outputs.issue_number }}');
            const stateLabelsArray = process.env.STATE_LABELS.trim().split('\n');
            const stateLabels = {
              queued: stateLabelsArray[0],
              working: stateLabelsArray[1],
              needsReview: stateLabelsArray[2],
              done: stateLabelsArray[3],
              failed: stateLabelsArray[4]
            };
            
            try {
              const hasChanges = '${{ steps.check-changes.outputs.has_changes }}' === 'true';
              const prExists = '${{ steps.create-pr.outputs.pr_exists }}' === 'true';
              const prNumber = '${{ steps.create-pr.outputs.pr_number }}';
              const jobStatus = '${{ job.status }}';
              
              // å¤‰æ›´ãŒãªã„å ´åˆã¯workingã‚’ç¶­æŒ
              if (!hasChanges) {
                console.log('No changes detected, keeping claude:working label');
                return;
              }
              
              // workingãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: stateLabels.working
              }).catch(() => {});
              
              // çµæœã«å¿œã˜ã¦é©åˆ‡ãªãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
              if (prExists || prNumber) {
                // PRä½œæˆæˆåŠŸã¾ãŸã¯æ—¢å­˜PR â†’ needs-review
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: [stateLabels.needsReview]
                });
                console.log('Added claude:needs-review label');
              } else if (jobStatus === 'failure' || (!prExists && !prNumber && hasChanges)) {
                // PRä½œæˆå¤±æ•— â†’ failed
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: [stateLabels.failed]
                });
                console.log('Added claude:failed label due to PR creation failure');
                
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿
                const errorBody = `âŒ PRä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚[ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: errorBody
                });
              }
            } catch (error) {
              console.error('Error updating labels:', error);
            }

  # Job 3: IssueãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚ŒãŸæ™‚ã«doneãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
  add-done-label:
    if: github.event_name == 'issues' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    
    steps:
      - name: Add claude:done label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const stateLabelsArray = process.env.STATE_LABELS.trim().split('\n');
            const stateLabels = {
              queued: stateLabelsArray[0],
              working: stateLabelsArray[1],
              needsReview: stateLabelsArray[2],
              done: stateLabelsArray[3],
              failed: stateLabelsArray[4]
            };
            
            try {
              // Get current issue labels
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
              
              // Check if any claude:* label exists
              const hasClaudeLabel = issue.data.labels.some(label => 
                label.name.startsWith('claude:')
              );
              
              // Only add claude:done if the issue had some claude label
              if (hasClaudeLabel) {
                console.log(`Issue #${issueNumber} was closed and has Claude labels`);
                
                // Remove any existing claude state labels
                for (const labelName of Object.values(stateLabels)) {
                  if (labelName !== stateLabels.done) {
                    await github.rest.issues.removeLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber,
                      name: labelName
                    }).catch(() => {
                      // Ignore if label doesn't exist
                    });
                  }
                }
                
                // Add claude:done label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: [stateLabels.done]
                });
                
                console.log(`Added ${stateLabels.done} label to closed issue #${issueNumber}`);
              } else {
                console.log(`Issue #${issueNumber} was closed but has no Claude labels, skipping`);
              }
              
            } catch (error) {
              console.error('Error handling issue close:', error);
              core.setFailed(error.message);
            }

  # Job 4: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° - ä»–ã®ã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã—ãŸå ´åˆã«failedãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
  fail-handler:
    if: failure()
    runs-on: ubuntu-latest
    needs: [process-issue, handle-claude-changes]
    
    steps:
      - name: Mark issue as failed
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const stateLabelsArray = process.env.STATE_LABELS.trim().split('\n');
            const stateLabels = {
              queued: stateLabelsArray[0],
              working: stateLabelsArray[1],
              needsReview: stateLabelsArray[2],
              done: stateLabelsArray[3],
              failed: stateLabelsArray[4]
            };
            
            // process-issueã‚¸ãƒ§ãƒ–ã‹ã‚‰issueç•ªå·ã‚’å–å¾—
            const issueNumber = '${{ needs.process-issue.outputs.issue_number }}' || 
                              '${{ needs.handle-claude-changes.outputs.issue_number }}';
            
            if (issueNumber && issueNumber !== '') {
              try {
                // å…¨ã¦ã®ClaudeçŠ¶æ…‹ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
                for (const labelName of Object.values(stateLabels)) {
                  if (labelName !== stateLabels.failed) {
                    await github.rest.issues.removeLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: parseInt(issueNumber),
                      name: labelName
                    }).catch(() => {});
                  }
                }
                
                // failedãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber),
                  labels: [stateLabels.failed]
                });
                
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
                const errorBody = [
                  'âŒ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚',
                  '',
                  `è©³ç´°ã¯[ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`,
                  '',
                  'å•é¡ŒãŒè§£æ±ºã—ãŸã‚‰ã€å†åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚'
                ].join('\n');
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(issueNumber),
                  body: errorBody
                });
                
              } catch (error) {
                console.error('Error in fail handler:', error);
              }
            }